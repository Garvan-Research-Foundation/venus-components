import{dedent as G}from"ts-dedent";import L from"global";import{logger as b}from"@storybook/client-logger";import{toId as z,sanitize as N}from"@storybook/csf";import{combineParameters as k,composeStepRunners as V,normalizeInputTypes as _}from"@storybook/store";import T from"global";import{dedent as R}from"ts-dedent";import{SynchronousPromise as O}from"synchronous-promise";import{toId as w,isExportStory as $,storyNameFromExport as v}from"@storybook/csf";import{userOrAutoTitle as M,sortStoriesV6 as C}from"@storybook/store";import{logger as D}from"@storybook/client-logger";var S=class{constructor(){this.projectAnnotations={loaders:[],decorators:[],parameters:{},argsEnhancers:[],argTypesEnhancers:[],args:{},argTypes:{}},this.entries={},this.csfExports={}}importFn(r){return O.resolve().then(()=>{let e=this.csfExports[r];if(!e)throw new Error(`Unknown path: ${r}`);return e})}getStoryIndex(r){let e=Object.keys(this.csfExports),c=this.projectAnnotations.parameters?.options?.storySort,g=Object.entries(this.entries).map(([s,{type:y,importPath:a,...i}])=>{let m=this.csfExports[a],d=r.processCSFFileWithCache(m,a,m.default.title),n;return y==="story"?n=r.storyFromCSFFile({storyId:s,csfFile:d}):n={...i,story:i.name,kind:i.title,componentId:w(i.componentId||i.title),parameters:{fileName:a}},[s,n,d.meta.parameters,this.projectAnnotations.parameters]}),p;try{p=C(g,c,e)}catch(s){throw typeof c=="function"?new Error(R`
          Error sorting stories with sort parameter ${c}:

          > ${s.message}
          
          Are you using a V7-style sort function in V6 compatibility mode?
          
          More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#v7-style-story-sort
        `):s}let o=p.reduce((s,y)=>(s[y.id]=this.entries[y.id],s),{});return{v:4,entries:o}}clearFilenameExports(r){!this.csfExports[r]||(Object.entries(this.entries).forEach(([e,{importPath:c}])=>{c===r&&delete this.entries[e]}),this.csfExports[r]={})}addStoriesFromExports(r,e){if(r.match(/\.mdx$/)&&!r.match(/\.stories\.mdx$/)||this.csfExports[r]===e)return;this.clearFilenameExports(r);let{default:c,__namedExportsOrder:h,...g}=e,{id:p,title:o,tags:s=[]}=c||{},y=(T.STORIES||[]).map(d=>({...d,importPathMatcher:new RegExp(d.importPathMatcher)}));if(o=M(r,y,o),!o){D.info(`Unexpected default export without title in '${r}': ${JSON.stringify(e.default)}`);return}this.csfExports[r]={...e,default:{...c,title:o}};let a=g;Array.isArray(h)&&(a={},h.forEach(d=>{let n=g[d];n&&(a[d]=n)}));let i=Object.entries(a).filter(([d])=>$(d,c)),m=T.DOCS_OPTIONS||{};if(m.enabled&&i.length&&(r.match(/\.mdx$/)||m.docsPage&&s.includes("docsPage"))){let d=m.defaultName,n=w(p||o,d);this.entries[n]={type:"docs",standalone:!1,id:n,title:o,name:d,importPath:r,...p&&{componentId:p},tags:[...s,"docs"],storiesImports:[]}}i.forEach(([d,n])=>{let u=v(d),A=n.parameters?.__id||w(p||o,u),E=typeof n!="function"&&n.name||n.storyName||n.story?.name||u;n.parameters?.docsOnly||(this.entries[A]={type:"story",id:A,name:E,title:o,importPath:r,...p&&{componentId:p},tags:[...n.tags||s,"story"]})})}};var l,Y={addDecorator:"Instead, use `export const decorators = [];` in your `preview.js`.",addParameters:"Instead, use `export const parameters = {};` in your `preview.js`.",addLoader:"Instead, use `export const loaders = [];` in your `preview.js`.",addArgs:"",addArgTypes:"",addArgsEnhancer:"",addArgTypesEnhancer:"",addStepRunner:"",getGlobalRender:"",setGlobalRender:""},f=t=>{if(L.FEATURES?.storyStoreV7)throw new Error(G`You cannot use \`${t}\` with the new Story Store.

      ${Y[t]}`);if(!l)throw new Error(`Singleton client API not yet initialized, cannot call \`${t}\`.`)},Q=t=>{f("addDecorator"),l.addDecorator(t)},U=t=>{f("addParameters"),l.addParameters(t)},B=t=>{f("addLoader"),l.addLoader(t)},H=t=>{f("addArgs"),l.addArgs(t)},J=t=>{f("addArgTypes"),l.addArgTypes(t)},W=t=>{f("addArgsEnhancer"),l.addArgsEnhancer(t)},q=t=>{f("addArgTypesEnhancer"),l.addArgTypesEnhancer(t)},K=t=>{f("addStepRunner"),l.addStepRunner(t)};var X=t=>{f("setGlobalRender"),l.facade.projectAnnotations.render=t},Z=new Set(["string","number","boolean","symbol"]),F=class{constructor({storyStore:r}={}){this.lastFileName=0;this.addDecorator=r=>{this.facade.projectAnnotations.decorators.push(r)};this.addParameters=({globals:r,globalTypes:e,...c})=>{this.facade.projectAnnotations.parameters=k(this.facade.projectAnnotations.parameters,c),r&&(this.facade.projectAnnotations.globals={...this.facade.projectAnnotations.globals,...r}),e&&(this.facade.projectAnnotations.globalTypes={...this.facade.projectAnnotations.globalTypes,..._(e)})};this.addStepRunner=r=>{this.facade.projectAnnotations.runStep=V([this.facade.projectAnnotations.runStep,r].filter(Boolean))};this.addLoader=r=>{this.facade.projectAnnotations.loaders.push(r)};this.addArgs=r=>{this.facade.projectAnnotations.args={...this.facade.projectAnnotations.args,...r}};this.addArgTypes=r=>{this.facade.projectAnnotations.argTypes={...this.facade.projectAnnotations.argTypes,..._(r)}};this.addArgsEnhancer=r=>{this.facade.projectAnnotations.argsEnhancers.push(r)};this.addArgTypesEnhancer=r=>{this.facade.projectAnnotations.argTypesEnhancers.push(r)};this._addedExports={};this.storiesOf=(r,e)=>{if(!r&&typeof r!="string")throw new Error("Invalid or missing kind provided for stories, should be a string");if(e||b.warn(`Missing 'module' parameter for story with a kind of '${r}'. It will break your HMR`),e){let a=Object.getPrototypeOf(e);a.exports&&a.exports.default&&b.error(`Illegal mix of CSF default export and storiesOf calls in a single file: ${a.i}`)}let c=e&&e.id?`${e.id}`:(this.lastFileName++).toString(),h=c,g=1;for(;this._addedExports[h];)g+=1,h=`${c}-${g}`;e&&e.hot&&e.hot.accept&&(e.hot.accept(),e.hot.dispose(()=>{this.facade.clearFilenameExports(h),delete this._addedExports[h],setTimeout(()=>{this._loadAddedExports(),this.onImportFnChanged?.({importFn:this.importFn.bind(this)})},0)}));let p=!1,o={kind:r.toString(),add:()=>o,addDecorator:()=>o,addLoader:()=>o,addParameters:()=>o};Object.keys(this.addons).forEach(a=>{let i=this.addons[a];o[a]=(...m)=>(i.apply(o,m),o)});let s={id:N(r),title:r,decorators:[],loaders:[],parameters:{}};this._addedExports[h]={default:s};let y=0;return o.add=(a,i,m={})=>{if(p=!0,typeof a!="string")throw new Error(`Invalid or missing storyName provided for a "${r}" story.`);if(!i||Array.isArray(i)||Z.has(typeof i))throw new Error(`Cannot load story "${a}" in "${r}" due to invalid format. Storybook expected a function/object but received ${typeof i} instead.`);let{decorators:d,loaders:n,component:u,args:A,argTypes:E,...I}=m,P=m.__id||z(r,a),j=this._addedExports[h];return j[`story${y}`]={name:a,parameters:{fileName:h,__id:P,...I},decorators:d,loaders:n,args:A,argTypes:E,component:u,render:i},y+=1,o},o.addDecorator=a=>{if(p)throw new Error(`You cannot add a decorator after the first story for a kind.
Read more here: https://github.com/storybookjs/storybook/blob/master/MIGRATION.md#can-no-longer-add-decoratorsparameters-after-stories`);return s.decorators.push(a),o},o.addLoader=a=>{if(p)throw new Error("You cannot add a loader after the first story for a kind.");return s.loaders.push(a),o},o.addParameters=({component:a,args:i,argTypes:m,tags:d,...n})=>{if(p)throw new Error(`You cannot add parameters after the first story for a kind.
Read more here: https://github.com/storybookjs/storybook/blob/master/MIGRATION.md#can-no-longer-add-decoratorsparameters-after-stories`);return s.parameters=k(s.parameters,n),a&&(s.component=a),i&&(s.args={...s.args,...i}),m&&(s.argTypes={...s.argTypes,...m}),d&&(s.tags=d),o},o};this.raw=()=>this.storyStore.raw();this.facade=new S,this.addons={},this.storyStore=r,l=this}importFn(r){return this.facade.importFn(r)}getStoryIndex(){if(!this.storyStore)throw new Error("Cannot get story index before setting storyStore");return this.facade.getStoryIndex(this.storyStore)}_loadAddedExports(){Object.entries(this._addedExports).forEach(([r,e])=>this.facade.addStoriesFromExports(r,e))}get _storyStore(){return this.storyStore}};import rr from"global";import{parse as tr}from"qs";var er=()=>{let{document:t}=rr;return t&&t.location&&t.location.search?tr(t.location.search,{ignoreQueryPrefix:!0}):{}},Sr=t=>er()[t];export{F as ClientApi,J as addArgTypes,q as addArgTypesEnhancer,H as addArgs,W as addArgsEnhancer,Q as addDecorator,B as addLoader,U as addParameters,K as addStepRunner,Sr as getQueryParam,er as getQueryParams,X as setGlobalRender};
